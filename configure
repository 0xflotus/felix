#!/usr/bin/env python
import os
import sys
import glob

def run(*args):
    cmd = ' '.join(args)
    print 'RUNNING', cmd
    return os.system('%s %s' % (sys.executable, cmd))

def main():
    flx_dir = os.path.dirname(sys.argv[0])
    lparchive = os.environ.get('FLX_LPARCHIVE', flx_dir)

    i = 0
    while i < len(sys.argv):
        arg = sys.argv[i]

        if arg.startswith('--lparchive='):
            lparchive = arg[9:]
        elif arg == '--lparchive':
            lparchive = sys.argv[i+1]
            i += 1
        elif arg == '--help':
            print "Usage: configure [options]"
            print
            print "Options are:"
            print "  --prefix path:      set path for installation"
            print "  --lparchive path:   the location of the lpsrc directory"
            print "  --help:             display this message and exit"
            print
            return 0
        elif arg == '--':
            # respect request to stop parsing args
            break
        i += 1

    os.environ['FLX_DIR'] = flx_dir
    os.environ['PYTHONPATH'] = flx_dir + os.pathsep + os.environ.get('PYTHONPATH', '')
    os.environ['FLX_LPARCHIVE'] = lparchive

    print 'Configuring Felix'
    print 'FLX_LPARCHIVE at', lparchive

    lpsrc = os.path.join(lparchive, 'lpsrc')
    iscr = os.path.join(flx_dir, 'interscript', 'bin', 'iscr.py')

    if run(iscr, '--cache-prefix=lpsrc-cache', '--break-on-error', os.path.join(lpsrc, 'flx_config.pak')):
        print >> sys.stderr, 'ERROR EXTRACTING CONFIGURATION PROGRAM'
        return 1

    if run(os.path.join('script', 'make_config.py'), *sys.argv[1:]):
        print >> sys.stderr, 'ERROR CONFIGURING'
        return 1

    if run(iscr, '--cache-prefix=lpsrc-cache', '--break-on-error', os.path.join(lpsrc, 'flx_maker.pak')):
        print >> sys.stderr, 'ERROR EXTRACTING MAKER PROGRAM'
        return 1

    return 0

if __name__ == '__main__':
    sys.exit(main())
